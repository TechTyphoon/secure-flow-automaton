<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Secure Flow API Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0,0,0,0.15);
        }

        .metric-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .metric-subtitle {
            font-size: 0.9rem;
            color: #64748b;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .time-selector {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .alerts-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alerts-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .alert-count {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .alert-item {
            padding: 1rem;
            border-left: 4px solid #ef4444;
            background: #fef2f2;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .alert-item.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .alert-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .alert-time {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .endpoints-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            background: #f8fafc;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .endpoint-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
        }

        .endpoint-row:hover {
            background: #f8fafc;
        }

        .endpoint-name {
            font-weight: 500;
            color: #1e293b;
        }

        .endpoint-method {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .method-GET { background: #dcfce7; color: #166534; }
        .method-POST { background: #dbeafe; color: #1e40af; }
        .method-PUT { background: #fef3c7; color: #92400e; }
        .method-DELETE { background: #fee2e2; color: #991b1b; }

        .status-healthy { color: #10b981; font-weight: 600; }
        .status-degraded { color: #f59e0b; font-weight: 600; }
        .status-unhealthy { color: #ef4444; font-weight: 600; }

        .response-time {
            text-align: right;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .response-time.fast { color: #10b981; }
        .response-time.medium { color: #f59e0b; }
        .response-time.slow { color: #ef4444; }

        .footer {
            text-align: center;
            padding: 2rem;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
            background: white;
            margin-top: 2rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }

            .metrics-grid, .charts-grid {
                grid-template-columns: 1fr;
            }

            .endpoint-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Secure Flow API Monitoring Dashboard</h1>
        <div class="status">
            <div class="status-indicator" id="connectionStatus"></div>
            <span id="connectionText">Connecting...</span>
            <span id="uptime">Uptime: 0s</span>
            <span id="lastUpdate">Last Update: Never</span>
        </div>
    </div>

    <div class="dashboard">
        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">üè• System Health</div>
                <div class="metric-value" id="systemHealth">--</div>
                <div class="metric-subtitle" id="systemHealthText">Loading...</div>
            </div>

            <div class="metric-card">
                <div class="metric-title">‚ö° Response Time</div>
                <div class="metric-value" id="avgResponseTime">--ms</div>
                <div class="metric-subtitle" id="responseTimeStatus">Loading...</div>
            </div>

            <div class="metric-card">
                <div class="metric-title">üìà Throughput</div>
                <div class="metric-value" id="throughput">--req/s</div>
                <div class="metric-subtitle" id="throughputStatus">Requests per second</div>
            </div>

            <div class="metric-card">
                <div class="metric-title">üö® Error Rate</div>
                <div class="metric-value" id="errorRate">0%</div>
                <div class="metric-subtitle" id="errorRateText">Last 5 minutes</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">üìä Response Time Trend</div>
                    <div class="chart-controls">
                        <select class="time-selector" id="responseTimeRange">
                            <option value="300000">5 minutes</option>
                            <option value="900000">15 minutes</option>
                            <option value="1800000">30 minutes</option>
                            <option value="3600000">1 hour</option>
                        </select>
                    </div>
                </div>
                <canvas id="responseTimeChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">üîÑ Request Throughput</div>
                    <div class="chart-controls">
                        <select class="time-selector" id="throughputRange">
                            <option value="300000">5 minutes</option>
                            <option value="900000">15 minutes</option>
                            <option value="1800000">30 minutes</option>
                            <option value="3600000">1 hour</option>
                        </select>
                    </div>
                </div>
                <canvas id="throughputChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section">
            <div class="alerts-header">
                <div class="alerts-title">üö® Active Alerts</div>
                <div class="alert-count" id="alertCount">0</div>
            </div>
            <div id="alertsContainer">
                <div class="alert-item info">
                    <div class="alert-title">Dashboard Connected</div>
                    <div class="alert-message">Real-time monitoring is active</div>
                    <div class="alert-time">Just now</div>
                </div>
            </div>
        </div>

        <!-- Endpoints Table -->
        <div class="endpoints-table">
            <div class="table-header">
                <div class="table-title">üîó Endpoint Performance</div>
            </div>
            <div id="endpointsTable">
                <div class="endpoint-row">
                    <div class="endpoint-name">Loading endpoints...</div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>üîí Secure Flow Automaton - Real-Time API Monitoring Dashboard v1.0.0</p>
        <p>Built with ‚ù§Ô∏è for enterprise-grade API monitoring</p>
    </div>

    <script>
        // Dashboard state
        let socket;
        let charts = {};
        let dashboardData = {
            metrics: null,
            performance: null,
            alerts: []
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeCharts();
            setupEventListeners();
            updateConnectionStatus('connecting');
        });

        // Initialize WebSocket connection
        function initializeWebSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('üîó Connected to dashboard server');
                updateConnectionStatus('connected');
            });

            socket.on('disconnect', function() {
                console.log('üì¥ Disconnected from dashboard server');
                updateConnectionStatus('disconnected');
            });

            socket.on('dashboard-init', function(data) {
                console.log('üìä Dashboard initialized with data:', data);
                dashboardData = { ...dashboardData, ...data };
                updateDashboard();
            });

            socket.on('metrics-update', function(metrics) {
                dashboardData.metrics = metrics;
                updateDashboard();
                updateCharts();
            });

            socket.on('performance-stats', function(stats) {
                dashboardData.performance = stats;
                updatePerformanceMetrics();
            });

            socket.on('alerts-update', function(alerts) {
                dashboardData.alerts = alerts;
                updateAlerts();
            });

            socket.on('collection-error', function(error) {
                console.error('üìä Collection error:', error);
                showAlert('Collection Error', error.message, 'error');
            });
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');

            switch(status) {
                case 'connecting':
                    indicator.style.background = '#f59e0b';
                    text.textContent = 'Connecting...';
                    break;
                case 'connected':
                    indicator.style.background = '#10b981';
                    text.textContent = 'Connected';
                    break;
                case 'disconnected':
                    indicator.style.background = '#ef4444';
                    text.textContent = 'Disconnected';
                    break;
            }
        }

        // Update dashboard with new data
        function updateDashboard() {
            if (!dashboardData.metrics) return;

            updateSystemHealth();
            updatePerformanceMetrics();
            updateEndpointsTable();
            updateLastUpdate();

            // Update uptime every second
            if (dashboardData.uptime !== undefined) {
                setInterval(() => {
                    dashboardData.uptime++;
                    document.getElementById('uptime').textContent =
                        `Uptime: ${formatUptime(dashboardData.uptime)}`;
                }, 1000);
            }
        }

        // Update system health display
        function updateSystemHealth() {
            const systemHealth = document.getElementById('systemHealth');
            const systemHealthText = document.getElementById('systemHealthText');

            if (dashboardData.metrics?.system?.health?.length > 0) {
                const latest = dashboardData.metrics.system.health[dashboardData.metrics.system.health.length - 1];
                systemHealth.textContent = latest.status.toUpperCase();
                systemHealthText.textContent = `${latest.services || 0} services, ${latest.healthyServices || 0} healthy`;

                systemHealth.className = 'metric-value';
                if (latest.status === 'healthy') {
                    systemHealth.classList.add('status-healthy');
                } else if (latest.status === 'degraded') {
                    systemHealth.classList.add('status-degraded');
                } else {
                    systemHealth.classList.add('status-unhealthy');
                }
            }
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            if (!dashboardData.performance) return;

            const avgResponseTime = document.getElementById('avgResponseTime');
            const responseTimeStatus = document.getElementById('responseTimeStatus');
            const throughput = document.getElementById('throughput');
            const errorRate = document.getElementById('errorRate');
            const errorRateText = document.getElementById('errorRateText');

            avgResponseTime.textContent = `${Math.round(dashboardData.performance.averageResponseTime || 0)}ms`;

            if (dashboardData.performance.averageResponseTime < 200) {
                responseTimeStatus.textContent = 'Excellent';
                avgResponseTime.className = 'metric-value response-time fast';
            } else if (dashboardData.performance.averageResponseTime < 500) {
                responseTimeStatus.textContent = 'Good';
                avgResponseTime.className = 'metric-value response-time medium';
            } else {
                responseTimeStatus.textContent = 'Needs attention';
                avgResponseTime.className = 'metric-value response-time slow';
            }

            throughput.textContent = `${dashboardData.performance.throughput?.toFixed(1) || 0}req/s`;
            errorRate.textContent = `${dashboardData.performance.errorRate?.toFixed(1) || 0}%`;
        }

        // Update endpoints table
        function updateEndpointsTable() {
            const table = document.getElementById('endpointsTable');
            if (!dashboardData.metrics?.endpoints) return;

            const endpoints = Object.entries(dashboardData.metrics.endpoints);
            if (endpoints.length === 0) return;

            let html = '';

            endpoints.forEach(([endpointName, metrics]) => {
                if (metrics.length === 0) return;

                const latest = metrics[metrics.length - 1];
                const responseTimeClass = latest.responseTime < 200 ? 'fast' :
                                        latest.responseTime < 500 ? 'medium' : 'slow';

                html += `
                    <div class="endpoint-row">
                        <div class="endpoint-name">${endpointName}</div>
                        <div><span class="endpoint-method method-${latest.method}">${latest.method}</span></div>
                        <div class="status-${latest.success ? 'healthy' : 'unhealthy'}">
                            ${latest.success ? '‚úÖ' : '‚ùå'}
                        </div>
                        <div class="response-time ${responseTimeClass}">${latest.responseTime}ms</div>
                        <div>${latest.status}</div>
                    </div>
                `;
            });

            table.innerHTML = html;
        }

        // Update alerts display
        function updateAlerts() {
            const container = document.getElementById('alertsContainer');
            const count = document.getElementById('alertCount');

            count.textContent = dashboardData.alerts.length;

            if (dashboardData.alerts.length === 0) {
                container.innerHTML = `
                    <div class="alert-item info">
                        <div class="alert-title">All Clear</div>
                        <div class="alert-message">No active alerts</div>
                        <div class="alert-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                return;
            }

            let html = '';
            dashboardData.alerts.forEach(alert => {
                const severityClass = alert.severity === 'critical' ? 'error' :
                                    alert.severity === 'warning' ? 'warning' : 'info';

                html += `
                    <div class="alert-item ${severityClass}">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update last update timestamp
        function updateLastUpdate() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (dashboardData.metrics?.timestamp) {
                lastUpdate.textContent = `Last Update: ${new Date(dashboardData.metrics.timestamp).toLocaleTimeString()}`;
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Response Time Chart
            const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
            charts.responseTime = new Chart(responseTimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Throughput Chart
            const throughputCtx = document.getElementById('throughputChart').getContext('2d');
            charts.throughput = new Chart(throughputCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests/sec',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Requests/second'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update charts with new data
        function updateCharts() {
            if (!dashboardData.metrics?.performance) return;

            const performance = dashboardData.metrics.performance;

            // Update response time chart
            if (performance.responseTimes?.length > 0) {
                const labels = performance.responseTimes.map((_, i) => `${i * 30}s ago`);
                charts.responseTime.data.labels = labels;
                charts.responseTime.data.datasets[0].data = performance.responseTimes;
                charts.responseTime.update();
            }

            // Update throughput chart
            if (performance.throughput?.length > 0) {
                const labels = performance.throughput.map((_, i) => `${i * 30}s ago`);
                charts.throughput.data.labels = labels;
                charts.throughput.data.datasets[0].data = performance.throughput;
                charts.throughput.update();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Time range selectors
            document.getElementById('responseTimeRange').addEventListener('change', function(e) {
                socket.emit('request-performance', parseInt(e.target.value));
            });

            document.getElementById('throughputRange').addEventListener('change', function(e) {
                socket.emit('request-performance', parseInt(e.target.value));
            });
        }

        // Show alert function
        function showAlert(title, message, type = 'info') {
            const container = document.getElementById('alertsContainer');
            const alertHtml = `
                <div class="alert-item ${type}">
                    <div class="alert-title">${title}</div>
                    <div class="alert-message">${message}</div>
                    <div class="alert-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            container.insertAdjacentHTML('afterbegin', alertHtml);
        }

        // Format uptime
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Request initial data
        setTimeout(() => {
            if (socket && socket.connected) {
                socket.emit('request-metrics');
                socket.emit('request-performance', 300000); // 5 minutes
            }
        }, 1000);
    </script>
</body>
</html>
