name: ðŸ”§ API Testing & Documentation CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/web/**/*.ts'
      - 'apps/web/**/*.js'
      - 'docs/api/**'
      - 'openapi.yaml'
      - '.github/workflows/api-testing.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/web/**/*.ts'
      - 'apps/web/**/*.js'
      - 'docs/api/**'
      - 'openapi.yaml'
      - '.github/workflows/api-testing.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  CI: 'true'

jobs:
  # === VALIDATE OPENAPI SPECIFICATION ===
  validate-openapi:
    name: ðŸ“‹ Validate OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline

    - name: ðŸ“‹ Validate OpenAPI Specification
      run: |
        echo "ðŸ“‹ Validating OpenAPI specification..."
        if [ -f "openapi.yaml" ]; then
          echo "âœ… OpenAPI specification file exists"
          # Basic validation - check if it's valid YAML
          node -e "
            const yaml = require('js-yaml');
            const fs = require('fs');
            try {
              const doc = yaml.load(fs.readFileSync('openapi.yaml', 'utf8'));
              console.log('âœ… OpenAPI specification is valid YAML');
              console.log('ðŸ“Š API Version:', doc.info?.version || 'N/A');
              console.log('ðŸ”— Paths:', Object.keys(doc.paths || {}).length);
            } catch (e) {
              console.error('âŒ Invalid OpenAPI specification:', e.message);
              process.exit(1);
            }
          "
        else
          echo "âŒ OpenAPI specification file not found"
          exit 1
        fi

  # === RUN API TESTS (CI-OPTIMIZED) ===
  api-tests:
    name: ðŸ§ª API Tests (CI Environment)
    runs-on: ubuntu-latest
    needs: validate-openapi

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline

    - name: ðŸ§ª Run API Tests (CI Mode)
      run: |
        echo "ðŸ§ª Running API tests in CI environment..."
        echo "â„¹ï¸ Tests will run in CI mode and skip connection-dependent tests"
        
        # Set CI environment variables
        export CI=true
        export DOCKER_BUILD=true
        
        # Run the API test suite
        node docs/api/tests/api-test.js
      env:
        CI: true
        DOCKER_BUILD: true
        NODE_ENV: test

    - name: ðŸ“Š Test Results Summary
      if: always()
      run: |
        echo "ðŸ“Š API Test Results Summary:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Tests completed in CI mode"
        echo "â„¹ï¸ Connection tests were skipped (expected in CI)"
        echo "ðŸ“‹ All tests should show 'SKIPPED in CI' status"

  # === GENERATE TEST SUMMARY ===
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [validate-openapi, api-tests]
    if: always()

    steps:
    - name: ðŸ“Š Generate Test Summary
      run: |
        echo "ðŸŽ¯ API Testing & Documentation CI/CD Results:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ "${{ needs.validate-openapi.result }}" = "success" ]; then
          echo "âœ… OpenAPI Validation: PASSED"
        else
          echo "âŒ OpenAPI Validation: FAILED"
        fi
        
        if [ "${{ needs.api-tests.result }}" = "success" ]; then
          echo "âœ… API Tests: PASSED (CI Mode)"
        else
          echo "âŒ API Tests: FAILED"
        fi
        
        echo ""
        echo "ðŸ“‹ Summary:"
        echo "â€¢ OpenAPI specification validation completed"
        echo "â€¢ API tests ran in CI mode (connection tests skipped)"
        echo "â€¢ All tests should complete successfully in CI environment"
        echo ""
        echo "ðŸ”— View detailed results in the Actions tab"
        
        # Create summary artifact
        cat > api-test-summary.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "workflow": "${{ github.workflow }}",
          "run_id": "${{ github.run_id }}",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "trigger": "${{ github.event_name }}",
          "test_results": {
            "openapi_validation": "${{ needs.validate-openapi.result }}",
            "api_tests": "${{ needs.api-tests.result }}"
          },
          "ci_mode": true,
          "overall_status": "${{ job.status }}"
        }
        EOF

    - name: ðŸ“¤ Upload Test Summary
      uses: actions/upload-artifact@v4
      with:
        name: api-testing-summary
        path: api-test-summary.json
        retention-days: 30
