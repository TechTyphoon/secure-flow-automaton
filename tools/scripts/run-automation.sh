#!/bin/bash

# ğŸ¤– SECURE-FLOW-AUTOMATON MASTER LAUNCHER
# Complete automation from scratch - just run this script!

set -e

echo "ğŸš€ SECURE-FLOW-AUTOMATON MASTER AUTOMATION"
echo "=========================================="
echo "ğŸ¤– Starting complete automation from scratch..."
echo ""

# Function to print colored output
print_status() {
    echo -e "\e[32mâœ… $1\e[0m"
}

print_error() {
    echo -e "\e[31mâŒ $1\e[0m"
}

print_info() {
    echo -e "\e[34mâ„¹ï¸  $1\e[0m"
}

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    print_error "package.json not found. Please run this from the project root."
    exit 1
fi

print_info "Phase 1: Environment Setup"
echo "----------------------------"

# Install dependencies
print_info "Installing dependencies..."
npm ci
print_status "Dependencies installed"

# Run the auto-setup script
print_info "Running automated setup..."
node scripts/auto-setup.js
print_status "Automated setup completed"

print_info "Phase 2: Validation & Testing"
echo "------------------------------"

# Run all tests
print_info "Running comprehensive tests..."
npm test
print_status "All tests passed"

# Build project
print_info "Building project..."
npm run build
print_status "Build successful"

# Security and quality checks
print_info "Running security scans..."
npm run lint:security
print_status "Security scans completed"

print_info "Phase 3: Git Operations"
echo "-----------------------"

# Check git status
if [ -n "$(git status --porcelain)" ]; then
    print_info "Changes detected, committing..."
    
    git add .
    git commit -m "ğŸ¤– MASTER AUTOMATION COMPLETE - $(date -u +%Y-%m-%dT%H:%M:%SZ)

    âœ… Full automation setup completed
    âœ… All tests passing
    âœ… Build successful
    âœ… Security validated
    âœ… Ready for production deployment
    
    Generated by: Master Automation Launcher"
    
    git push origin main
    print_status "Changes committed and pushed"
else
    print_info "No changes to commit"
fi

print_info "Phase 4: Continuous Monitoring Setup"
echo "------------------------------------"

# Create monitoring script if it doesn't exist
if [ ! -f "monitor.sh" ]; then
    cat > monitor.sh << 'EOF'
#!/bin/bash

echo "ğŸ”„ Starting continuous monitoring..."

while true; do
    echo "ğŸ” $(date): Checking project health..."
    
    # Pull latest changes
    git pull origin main
    
    # Quick health check
    if npm test > /dev/null 2>&1; then
        echo "âœ… Health check passed"
    else
        echo "âŒ Health check failed - manual intervention needed"
    fi
    
    # Wait 5 minutes
    sleep 300
done
EOF
    chmod +x monitor.sh
fi

print_status "Monitoring script ready"

echo ""
echo "ğŸ‰ MASTER AUTOMATION COMPLETED SUCCESSFULLY!"
echo "============================================"
echo ""
echo "ğŸ“Š AUTOMATION SUMMARY:"
echo "âœ… Environment setup complete"
echo "âœ… Dependencies installed and updated"
echo "âœ… All tests passing"
echo "âœ… Build successful"
echo "âœ… Security scans completed"
echo "âœ… Changes committed to Git"
echo "âœ… GitHub Actions triggered"
echo "âœ… Monitoring scripts ready"
echo ""
echo "ğŸš€ WHAT'S RUNNING AUTOMATICALLY:"
echo "â€¢ GitHub Actions workflows (triggered on every push)"
echo "â€¢ Security scans (daily schedule)"
echo "â€¢ Dependency monitoring (automated)"
echo "â€¢ Build and deployment pipeline"
echo ""
echo "ğŸ“± NEXT ACTIONS:"
echo "â€¢ Check GitHub Actions tab for workflow status"
echo "â€¢ Run 'npm run auto:monitor' for continuous monitoring"
echo "â€¢ Run 'npm run auto:status' to check automation status"
echo ""
echo "ğŸ“„ Files generated:"
echo "â€¢ automation.log (detailed logs)"
echo "â€¢ AUTOMATION_REPORT.md (summary report)"
echo "â€¢ monitor.sh (continuous monitoring)"
echo ""
echo "ğŸ¯ Project is now fully automated and production-ready!"
echo ""
